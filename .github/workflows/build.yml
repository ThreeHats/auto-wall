name: Build Auto-Wall Multi-Platform

on:
  push:
    tags:
      - '*.*.*'  # Run when a version tag is pushed
  workflow_dispatch:  # Allow manual triggering
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'auto_wall.py'
      - 'requirements.txt'
      - 'build.py'
      - 'build/**'

permissions:
  contents: write
  discussions: write
  packages: write

jobs:
  # Version setup job to extract version once
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set_version.outputs.version }}
      is_release: ${{ steps.set_version.outputs.is_release }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set version number
      id: set_version
      run: |
        if [[ "${{ github.ref_type }}" == "tag" ]]; then
          VERSION="${{ github.ref_name }}"
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}
          IS_RELEASE="true"
          echo "Setting release version to $VERSION"
        else
          # For non-tag builds, use current date and commit
          VERSION="dev-$(date +%Y%m%d)-$(echo ${{ github.sha }} | cut -c1-7)"
          IS_RELEASE="false"
          echo "Setting dev version to $VERSION"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "is_release=$IS_RELEASE" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        
        # Update version in auto_wall.py
        sed -i "s/APP_VERSION = \".*\"/APP_VERSION = \"$VERSION\"/" auto_wall.py
  
  # Windows build job
  build-windows:
    needs: version
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Update version
      run: |
        $VERSION = "${{ needs.version.outputs.version }}"
        $CONTENT = Get-Content -Path "auto_wall.py" -Raw
        $NEW_CONTENT = $CONTENT -replace 'APP_VERSION = ".*"', "APP_VERSION = `"$VERSION`""
        Set-Content -Path "auto_wall.py" -Value $NEW_CONTENT -NoNewline
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Build Windows executable
      run: |
        python build.py --platform windows
    
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Auto-Wall-Windows-${{ needs.version.outputs.version }}
        path: |
          dist/Auto-Wall.exe
          dist/*.zip
        retention-days: 30
  
  # Linux build job
  build-linux:
    needs: version
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Update version
      run: |
        VERSION="${{ needs.version.outputs.version }}"
        sed -i "s/APP_VERSION = \".*\"/APP_VERSION = \"$VERSION\"/" auto_wall.py
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-dev python3-tk \
          fakeroot wget file desktop-file-utils \
          gzip
    
    - name: Install Python dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Build Linux packages
      run: |
        python3 build.py --platform linux
    
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Auto-Wall-Linux-${{ needs.version.outputs.version }}
        path: |
          dist/Auto-Wall
          dist/*.AppImage
          dist/*.deb
        retention-days: 30
  
  # macOS build job (placeholder for future)
  build-macos:
    needs: version
    runs-on: macos-latest
    if: false  # Disabled until macOS build is implemented
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Update version
      run: |
        VERSION="${{ needs.version.outputs.version }}"
        sed -i "" "s/APP_VERSION = \".*\"/APP_VERSION = \"$VERSION\"/" auto_wall.py
    
    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Build macOS app
      run: |
        python3 build.py --platform macos
    
    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Auto-Wall-macOS-${{ needs.version.outputs.version }}
        path: |
          dist/*.app
          dist/*.zip
        retention-days: 30
  
  # Release job - only runs on tag pushes
  release:
    if: needs.version.outputs.is_release == 'true'
    needs: [version, build-windows, build-linux]
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Display structure of downloaded files
      run: ls -la artifacts/
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/**/*
        draft: false
        prerelease: false
        tag_name: ${{ github.ref_name }}
        name: "Auto-Wall v${{ needs.version.outputs.version }}"
        body: |
          ## Auto-Wall v${{ needs.version.outputs.version }}
          
          ### üì• Downloads
          
          **Windows:**
          - `Auto-Wall.exe` - Standalone executable
          - `Auto-Wall-*-Windows.zip` - ZIP distribution
          
          **Linux:**
          - `Auto-Wall-*-x86_64.AppImage` - Universal Linux package (recommended)
          - `auto-wall_*_amd64.deb` - Debian/Ubuntu package
          - `Auto-Wall` - Standalone executable
          
          ### üöÄ Installation
          
          **Windows:** Download and run `Auto-Wall.exe`
          
          **Linux:** 
          - AppImage: `chmod +x Auto-Wall-*.AppImage && ./Auto-Wall-*.AppImage`
          - Debian: `sudo dpkg -i auto-wall_*.deb`
          
          ### üìù Changes
          
          See the [changelog](https://github.com/ThreeHats/auto-wall/releases) for detailed changes in this version.
        generate_release_notes: true